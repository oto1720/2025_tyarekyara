# èªè¨¼æ©Ÿèƒ½ (Auth Feature) - è©³ç´°ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

## ç›®æ¬¡

1. [æ¦‚è¦](#æ¦‚è¦)
2. [ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ã¨å„ãƒ•ã‚¡ã‚¤ãƒ«ã®å½¹å‰²](#ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ã¨å„ãƒ•ã‚¡ã‚¤ãƒ«ã®å½¹å‰²)
3. [ä¾å­˜é–¢ä¿‚å›³](#ä¾å­˜é–¢ä¿‚å›³)
4. [ã‚¯ãƒ©ã‚¹å›³ã¨é–¢ä¿‚æ€§](#ã‚¯ãƒ©ã‚¹å›³ã¨é–¢ä¿‚æ€§)
5. [ä¸»è¦ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆè©³ç´°](#ä¸»è¦ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆè©³ç´°)
6. [ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼ã¨å‡¦ç†ã®æµã‚Œ](#ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼ã¨å‡¦ç†ã®æµã‚Œ)
7. [ä»–ã®featureã¨ã®é€£æº](#ä»–ã®featureã¨ã®é€£æº)
8. [ä½¿ç”¨æ–¹æ³•](#ä½¿ç”¨æ–¹æ³•)
9. [æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯](#æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯)
10. [ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£](#ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£)
11. [ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°](#ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°)

---

## æ¦‚è¦

ã“ã®èªè¨¼æ©Ÿèƒ½ã¯ã€Firebase Authenticationã‚’ä½¿ç”¨ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ã‚·ã‚¹ãƒ†ãƒ ã§ã™ã€‚

### æä¾›æ©Ÿèƒ½

- âœ… ãƒ¡ãƒ¼ãƒ«/ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼ï¼ˆç™»éŒ²ãƒ»ãƒ­ã‚°ã‚¤ãƒ³ï¼‰
- âœ… Googleèªè¨¼ï¼ˆå®Ÿè£…æ¸ˆã¿ï¼‰
- âœ… Appleèªè¨¼ï¼ˆå®Ÿè£…æ¸ˆã¿ï¼‰
- âœ… ã‚²ã‚¹ãƒˆãƒ­ã‚°ã‚¤ãƒ³
- âœ… ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¨­å®šï¼ˆã‚¢ã‚¤ã‚³ãƒ³ã€ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã€å¹´é½¢ã€åœ°åŸŸï¼‰
- âœ… ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆFirebase Storageï¼‰
- âœ… ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆ
- âœ… ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤

### ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ãƒ‘ã‚¿ãƒ¼ãƒ³

- **ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‰ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£**: Presentation â†’ Provider â†’ Repository â†’ Service
- **çŠ¶æ…‹ç®¡ç†**: Riverpodï¼ˆNotifierProviderï¼‰
- **ä¸å¤‰æ€§**: Freezed
- **ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°**: GoRouter

---

## ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ã¨å„ãƒ•ã‚¡ã‚¤ãƒ«ã®å½¹å‰²

```
lib/feature/auth/
â”‚
â”œâ”€â”€ models/                                    # ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«å±¤
â”‚   â””â”€â”€ user/
â”‚       â”œâ”€â”€ user_model.dart                    # ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¢ãƒ‡ãƒ«ï¼ˆFreezedï¼‰
â”‚       â”œâ”€â”€ user_model.freezed.dart            # è‡ªå‹•ç”Ÿæˆ
â”‚       â””â”€â”€ user_model.g.dart                  # JSON ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³
â”‚
â”œâ”€â”€ providers/                                 # çŠ¶æ…‹ç®¡ç†å±¤ï¼ˆRiverpodï¼‰
â”‚   â”œâ”€â”€ auth_provider.dart                     # ğŸ”‘ èªè¨¼ã®ä¸­å¿ƒçš„Provider
â”‚   â”‚   â”œâ”€ authServiceProvider                 #    â†’ AuthServiceã®DI
â”‚   â”‚   â”œâ”€ authStateChangesProvider            #    â†’ èªè¨¼çŠ¶æ…‹ã®Streamç›£è¦–
â”‚   â”‚   â”œâ”€ currentUserProvider                 #    â†’ ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—
â”‚   â”‚   â””â”€ authControllerProvider              #    â†’ èªè¨¼æ“ä½œã®å®Ÿè¡Œ
â”‚   â”‚
â”‚   â”œâ”€â”€ auth_state.dart                        # èªè¨¼çŠ¶æ…‹ã®å®šç¾©ï¼ˆFreezed Sealed Classï¼‰
â”‚   â”‚   â”œâ”€ initial                             #    â†’ åˆæœŸçŠ¶æ…‹
â”‚   â”‚   â”œâ”€ loading                             #    â†’ å‡¦ç†ä¸­
â”‚   â”‚   â”œâ”€ guest                               #    â†’ ã‚²ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰
â”‚   â”‚   â”œâ”€ authenticated                       #    â†’ èªè¨¼æ¸ˆã¿
â”‚   â”‚   â”œâ”€ unauthenticated                     #    â†’ æœªèªè¨¼
â”‚   â”‚   â””â”€ error                               #    â†’ ã‚¨ãƒ©ãƒ¼
â”‚   â”‚
â”‚   â”œâ”€â”€ auth_state.freezed.dart                # è‡ªå‹•ç”Ÿæˆ
â”‚   â”‚
â”‚   â”œâ”€â”€ profile_setup_provider.dart            # ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¨­å®šå°‚ç”¨Provider
â”‚   â”‚   â””â”€ ProfileSetupNotifier                #    â†’ ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¨­å®šãƒ­ã‚¸ãƒƒã‚¯
â”‚   â”‚       â”œâ”€ pickImage()                     #       â†’ ç”»åƒé¸æŠ
â”‚   â”‚       â”œâ”€ setAgeRange()                   #       â†’ å¹´é½¢è¨­å®š
â”‚   â”‚       â”œâ”€ setRegion()                     #       â†’ åœ°åŸŸè¨­å®š
â”‚   â”‚       â””â”€ saveProfile()                   #       â†’ ä¿å­˜å‡¦ç†
â”‚   â”‚
â”‚   â”œâ”€â”€ profile_setup_state.dart               # ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¨­å®šçŠ¶æ…‹
â”‚   â”œâ”€â”€ profile_setup_state.freezed.dart       # è‡ªå‹•ç”Ÿæˆ
â”‚   â”‚
â”‚   â””â”€â”€ storage_service_provider.dart          # StorageServiceã®Provider
â”‚
â”œâ”€â”€ repositories/                              # ãƒªãƒã‚¸ãƒˆãƒªå±¤ï¼ˆæŠ½è±¡ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ï¼‰
â”‚   â””â”€â”€ auth_repository.dart                   # ğŸ”‘ èªè¨¼ãƒªãƒã‚¸ãƒˆãƒªã®æŠ½è±¡å®šç¾©
â”‚       â”œâ”€ signUpWithEmail()                   #    â†’ ãƒ¡ãƒ¼ãƒ«ç™»éŒ²
â”‚       â”œâ”€ signInWithEmail()                   #    â†’ ãƒ¡ãƒ¼ãƒ«ãƒ­ã‚°ã‚¤ãƒ³
â”‚       â”œâ”€ signInWithGoogle()                  #    â†’ Googleèªè¨¼
â”‚       â”œâ”€ signInWithApple()                   #    â†’ Appleèªè¨¼
â”‚       â”œâ”€ signOut()                           #    â†’ ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
â”‚       â”œâ”€ getCurrentUser()                    #    â†’ ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—
â”‚       â”œâ”€ saveUserData()                      #    â†’ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ä¿å­˜
â”‚       â”œâ”€ getUserData()                       #    â†’ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿å–å¾—
â”‚       â”œâ”€ updateUserData()                    #    â†’ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿æ›´æ–°
â”‚       â”œâ”€ updateEmail()                       #    â†’ ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹æ›´æ–°
â”‚       â”œâ”€ updatePassword()                    #    â†’ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æ›´æ–°
â”‚       â”œâ”€ sendPasswordResetEmail()            #    â†’ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆ
â”‚       â””â”€ deleteAccount()                     #    â†’ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤
â”‚
â”œâ”€â”€ services/                                  # ã‚µãƒ¼ãƒ“ã‚¹å±¤ï¼ˆå®Ÿè£…ï¼‰
â”‚   â”œâ”€â”€ auth_service.dart                      # ğŸ”‘ AuthRepositoryã®å®Ÿè£…
â”‚   â”‚   â””â”€ AuthService                         #    â†’ Firebase Auth + Firestore
â”‚   â”‚       â”œâ”€ _auth (FirebaseAuth)            #       â†’ Firebase Authentication
â”‚   â”‚       â”œâ”€ _firestore (FirebaseFirestore)  #       â†’ Cloud Firestore
â”‚   â”‚       â””â”€ ã™ã¹ã¦ã®ãƒ¡ã‚½ãƒƒãƒ‰å®Ÿè£…
â”‚   â”‚
â”‚   â””â”€â”€ storage_service.dart                   # Firebase Storageæ“ä½œ
â”‚       â””â”€ StorageService
â”‚           â”œâ”€ uploadProfileImage()            #    â†’ ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
â”‚           â””â”€ deleteProfileImage()            #    â†’ ç”»åƒå‰Šé™¤
â”‚
â”œâ”€â”€ presentaion/                               # ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³å±¤ï¼ˆUIï¼‰
â”‚   â”œâ”€â”€ pages/
â”‚   â”‚   â”œâ”€â”€ login.dart                         # ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢
â”‚   â”‚   â”‚   â””â”€ LoginPage (HookConsumerWidget) âœ¨
â”‚   â”‚   â”‚       â”œâ”€ ä¾å­˜: authControllerProvider
â”‚   â”‚   â”‚       â””â”€ ä½¿ç”¨Widget: CustomTextField, CustomButton
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ signup_page.dart                   # æ–°è¦ç™»éŒ²ç”»é¢
â”‚   â”‚   â”‚   â””â”€ SignUpPage (HookConsumerWidget) âœ¨
â”‚   â”‚   â”‚       â”œâ”€ ä¾å­˜: authControllerProvider
â”‚   â”‚   â”‚       â””â”€ ãƒ•ã‚©ãƒ¼ãƒ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ profile_setup_page.dart            # ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¨­å®šç”»é¢
â”‚   â”‚   â”‚   â””â”€ ProfileSetupPage (HookConsumerWidget) âœ¨
â”‚   â”‚   â”‚       â”œâ”€ ä¾å­˜: profileSetupProvider
â”‚   â”‚   â”‚       â””â”€ ä¾å­˜: authControllerProvider
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ forgot_password_page.dart          # ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆç”»é¢
â”‚   â”‚   â”‚   â””â”€ ForgotPasswordPage (HookConsumerWidget) âœ¨
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ change_password_page.dart          # ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ç”»é¢
â”‚   â”‚       â””â”€ ChangePasswordPage (HookConsumerWidget) âœ¨
â”‚   â”‚
â”‚   â””â”€â”€ widgets/                               # ï¼ˆç¾åœ¨ã¯ç©ºï¼‰
â”‚
â”œâ”€â”€ ARCHITECTURE.md                            # ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è©³ç´°è¨­è¨ˆæ›¸
â”œâ”€â”€ README.md                                  # ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«
â”œâ”€â”€ firestore.rules.example                    # Firestore ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ä¾‹
â””â”€â”€ storage.rules.example                      # Storage ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ä¾‹
```

---

## ä¾å­˜é–¢ä¿‚å›³

### ãƒ•ã‚¡ã‚¤ãƒ«é–“ã®importä¾å­˜é–¢ä¿‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          Presentation Layer                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  login.dart                                                          â”‚
â”‚  â”œâ”€â”€ import: providers/auth_provider.dart â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  â”œâ”€â”€ import: providers/auth_state.dart            â”‚                â”‚
â”‚  â”œâ”€â”€ import: widgets/custom_text_field.dart       â”‚                â”‚
â”‚  â””â”€â”€ import: widgets/custom_button.dart           â”‚                â”‚
â”‚                                                    â”‚                â”‚
â”‚  signup_page.dart                                 â”‚                â”‚
â”‚  â”œâ”€â”€ import: providers/auth_provider.dart â”€â”€â”€â”€â”€â”€â”€â”€â”¤                â”‚
â”‚  â””â”€â”€ import: providers/auth_state.dart            â”‚                â”‚
â”‚                                                    â”‚                â”‚
â”‚  profile_setup_page.dart                          â”‚                â”‚
â”‚  â”œâ”€â”€ import: providers/auth_provider.dart â”€â”€â”€â”€â”€â”€â”€â”€â”¤                â”‚
â”‚  â”œâ”€â”€ import: providers/profile_setup_provider.dartâ”‚                â”‚
â”‚  â””â”€â”€ import: providers/profile_setup_state.dart   â”‚                â”‚
â”‚                                                    â”‚                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          Provider Layer             â–¼                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  auth_provider.dart â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”œâ”€â”€ import: auth_state.dart                         â”‚             â”‚
â”‚  â”œâ”€â”€ import: repositories/auth_repository.dart â”€â”€â”   â”‚             â”‚
â”‚  â”œâ”€â”€ import: services/auth_service.dart          â”‚   â”‚             â”‚
â”‚  â””â”€â”€ import: models/user/user_model.dart         â”‚   â”‚             â”‚
â”‚                                                   â”‚   â”‚             â”‚
â”‚  profile_setup_provider.dart                     â”‚   â”‚             â”‚
â”‚  â”œâ”€â”€ import: profile_setup_state.dart            â”‚   â”‚             â”‚
â”‚  â”œâ”€â”€ import: auth_provider.dart â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚             â”‚
â”‚  â”œâ”€â”€ import: storage_service_provider.dart           â”‚             â”‚
â”‚  â””â”€â”€ import: models/user/user_model.dart             â”‚             â”‚
â”‚                                                       â”‚             â”‚
â”‚  storage_service_provider.dart                       â”‚             â”‚
â”‚  â””â”€â”€ import: services/storage_service.dart           â”‚             â”‚
â”‚                                                       â”‚             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                        â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       Repository Layer                â–¼             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  auth_repository.dart (æŠ½è±¡ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹) â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â””â”€â”€ import: models/user/user_model.dart              â”‚           â”‚
â”‚                                                        â”‚           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Service Layer                   â–¼           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  auth_service.dart (å®Ÿè£…) â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚  â”œâ”€â”€ implements: repositories/auth_repository.dart                  â”‚
â”‚  â”œâ”€â”€ import: models/user/user_model.dart                            â”‚
â”‚  â”œâ”€â”€ import: firebase_auth                                          â”‚
â”‚  â””â”€â”€ import: cloud_firestore                                        â”‚
â”‚                                                                      â”‚
â”‚  storage_service.dart                                               â”‚
â”‚  â”œâ”€â”€ import: firebase_storage                                       â”‚
â”‚  â””â”€â”€ import: image_picker                                           â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        External Services                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  Firebase Authentication  â”‚  Cloud Firestore  â”‚  Firebase Storage   â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Provideré–“ã®ä¾å­˜é–¢ä¿‚

```
currentUserProvider
    â†“ depends on
authStateChangesProvider
    â†“ depends on
authServiceProvider â”€â”€â”€â”€â”€â”€â”
                          â”‚
authControllerProvider â”€â”€â”€â”¤
    â†“ depends on          â”‚
authServiceProvider â—„â”€â”€â”€â”€â”€â”˜
    â†“ provides
AuthService (implements AuthRepository)


profileSetupProvider
    â†“ depends on
â”Œâ”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        â”‚
authControllerProvider   storageServiceProvider
â”‚                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ã‚¯ãƒ©ã‚¹å›³ã¨é–¢ä¿‚æ€§

### ä¸»è¦ã‚¯ãƒ©ã‚¹ã®é–¢ä¿‚å›³

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            UI Layer                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â”‚ uses
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AuthController (Notifier<AuthState>)                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  - state: AuthState                                    â”‚  â”‚
â”‚  â”‚  - _authRepository: AuthRepository                     â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚  + signUpWithEmail()                             â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  + signInWithEmail()                             â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  + signInWithGoogle()                            â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  + signInWithApple()                             â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  + signOut()                                     â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  + updateProfile()                               â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  + deleteAccount()                               â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚ uses
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AuthRepository (abstract)                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  + authStateChanges: Stream<User?>                   â”‚  â”‚
â”‚  â”‚  + signUpWithEmail()                                 â”‚  â”‚
â”‚  â”‚  + signInWithEmail()                                 â”‚  â”‚
â”‚  â”‚  + signInWithGoogle()                                â”‚  â”‚
â”‚  â”‚  + signInWithApple()                                 â”‚  â”‚
â”‚  â”‚  + signOut()                                         â”‚  â”‚
â”‚  â”‚  + getCurrentUser(): User?                           â”‚  â”‚
â”‚  â”‚  + saveUserData(UserModel)                           â”‚  â”‚
â”‚  â”‚  + getUserData(String): UserModel?                   â”‚  â”‚
â”‚  â”‚  + updateUserData(UserModel)                         â”‚  â”‚
â”‚  â”‚  + updateEmail(String)                               â”‚  â”‚
â”‚  â”‚  + updatePassword(String)                            â”‚  â”‚
â”‚  â”‚  + reauthenticate(String)                            â”‚  â”‚
â”‚  â”‚  + sendPasswordResetEmail(String)                    â”‚  â”‚
â”‚  â”‚  + deleteAccount()                                   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â–²
                 â”‚ implements
                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AuthService                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  - _auth: FirebaseAuth                               â”‚  â”‚
â”‚  â”‚  - _firestore: FirebaseFirestore                     â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚  ã™ã¹ã¦ã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å®Ÿè£…                          â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  + Firebase Authenticationã¨ã®é€£æº              â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  + Cloud Firestoreã¨ã®é€£æº                      â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  + ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°                            â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### AuthStateã®çŠ¶æ…‹é·ç§»å›³

```
@freezed
class AuthState with _$AuthState {
  const factory AuthState.initial() = _Initial;
  const factory AuthState.loading() = _Loading;
  const factory AuthState.guest() = _Guest;
  const factory AuthState.authenticated(UserModel user) = _Authenticated;
  const factory AuthState.unauthenticated() = _Unauthenticated;
  const factory AuthState.error(String message) = _Error;
}

çŠ¶æ…‹é·ç§»:

        [initial]
            â”‚
            â”œâ”€â”€â”€ signUpWithEmail() â”€â”€â”€â†’ [loading] â”€â”€â”€â†’ [authenticated] / [error]
            â”‚                                              â”‚
            â”œâ”€â”€â”€ signInWithEmail() â”€â”€â”€â†’ [loading] â”€â”€â”€â”€â”€â”€â”€â”¤
            â”‚                                              â”‚
            â”œâ”€â”€â”€ signInWithGoogle() â”€â”€â†’ [loading] â”€â”€â”€â”€â”€â”€â”€â”¤
            â”‚                                              â”‚
            â”œâ”€â”€â”€ signInWithApple() â”€â”€â”€â†’ [loading] â”€â”€â”€â”€â”€â”€â”€â”¤
            â”‚                                              â”‚
            â”œâ”€â”€â”€ continueAsGuest() â”€â”€â”€â†’ [guest] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
            â”‚                                              â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                           â”‚
        [authenticated] â”€â”€â”€ signOut() â”€â”€â”€â†’ [loading] â”€â”€â”€â†’ [unauthenticated]
                      â”‚
                      â””â”€â”€â”€ deleteAccount() â”€â”€â†’ [loading] â”€â”€â†’ [unauthenticated]
```

### UserModelã®ãƒ‡ãƒ¼ã‚¿æ§‹é€ 

```
@freezed
class UserModel with _$UserModel {
  const factory UserModel({
    required String id,              // Firebase UID
    required String nickname,        // ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ  (2-20æ–‡å­—)
    required String email,           // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
    @Default('') String ageRange,    // å¹´é½¢ç¯„å›² ("10ä»£", "20ä»£", etc.)
    @Default('') String region,      // åœ°åŸŸï¼ˆéƒ½é“åºœçœŒï¼‰
    @Default('assets/images/default_avatar.png') String iconUrl,
    required DateTime createdAt,     // ä½œæˆæ—¥æ™‚
    required DateTime updatedAt,     // æ›´æ–°æ—¥æ™‚
  }) = _UserModel;

  factory UserModel.fromJson(Map<String, dynamic> json) =>
    _$UserModelFromJson(json);
}

Firestoreãƒ‡ãƒ¼ã‚¿æ§‹é€ :
users/{userId}/
  â”œâ”€ id: string
  â”œâ”€ nickname: string
  â”œâ”€ email: string
  â”œâ”€ ageRange: string
  â”œâ”€ region: string
  â”œâ”€ iconUrl: string
  â”œâ”€ createdAt: Timestamp
  â””â”€ updatedAt: Timestamp
```

### ProfileSetupStateã®ãƒ‡ãƒ¼ã‚¿æ§‹é€ 

```
@freezed
class ProfileSetupState with _$ProfileSetupState {
  const factory ProfileSetupState({
    File? selectedImage,           // é¸æŠã•ã‚ŒãŸç”»åƒãƒ•ã‚¡ã‚¤ãƒ«
    String? selectedAgeRange,      // é¸æŠã•ã‚ŒãŸå¹´é½¢ç¯„å›²
    String? selectedRegion,        // é¸æŠã•ã‚ŒãŸåœ°åŸŸ
    @Default(false) bool isUploading, // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­ãƒ•ãƒ©ã‚°
    String? errorMessage,          // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
  }) = _ProfileSetupState;
}

ProfileSetupNotifierã®ãƒ¡ã‚½ãƒƒãƒ‰:
  â”Œâ”€ pickImage() â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ selectedImageæ›´æ–°
  â”œâ”€ setAgeRange(String) â”€â†’ selectedAgeRangeæ›´æ–°
  â”œâ”€ setRegion(String) â”€â”€â”€â†’ selectedRegionæ›´æ–°
  â”œâ”€ saveProfile() â”€â”€â”€â”€â”€â”€â”€â†’ ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ + ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æ›´æ–°
  â”œâ”€ initializeFromUser() â†’ æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã§åˆæœŸåŒ–
  â”œâ”€ clearError() â”€â”€â”€â”€â”€â”€â”€â”€â†’ errorMessageå‰Šé™¤
  â””â”€ reset() â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ å…¨çŠ¶æ…‹ãƒªã‚»ãƒƒãƒˆ
```

---

## ä¸»è¦ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆè©³ç´°

### 1. AuthControllerï¼ˆèªè¨¼ã®ä¸­å¿ƒçš„ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ï¼‰

**ãƒ•ã‚¡ã‚¤ãƒ«**: `providers/auth_provider.dart`

**å½¹å‰²**: èªè¨¼ã«é–¢ã™ã‚‹ã™ã¹ã¦ã®æ“ä½œã‚’çµ±æ‹¬

**çŠ¶æ…‹**: `AuthState`ï¼ˆ6ã¤ã®çŠ¶æ…‹ã‚’æŒã¤Sealed Classï¼‰

**ä¸»è¦ãƒ¡ã‚½ãƒƒãƒ‰**:

| ãƒ¡ã‚½ãƒƒãƒ‰ | å¼•æ•° | æˆ»ã‚Šå€¤ | èª¬æ˜ | ä¾å­˜å…ˆ |
|---------|------|--------|------|-------|
| `signUpWithEmail()` | email, password, nickname | `Future<void>` | ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã§æ–°è¦ç™»éŒ² | `AuthService.signUpWithEmail()` |
| `signInWithEmail()` | email, password | `Future<void>` | ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã§ãƒ­ã‚°ã‚¤ãƒ³ | `AuthService.signInWithEmail()` |
| `signInWithGoogle()` | ãªã— | `Future<void>` | Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ | `AuthService.signInWithGoogle()` |
| `signInWithApple()` | ãªã— | `Future<void>` | Appleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ | `AuthService.signInWithApple()` |
| `signOut()` | ãªã— | `Future<void>` | ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ | `AuthService.signOut()` |
| `continueAsGuest()` | ãªã— | `void` | ã‚²ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã§ç¶šè¡Œ | ãªã— |
| `updateProfile()` | userId, nickname, ageRange, region, iconUrl | `Future<void>` | ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æ›´æ–° | `AuthService.updateUserData()` |
| `fetchUserData()` | userId | `Future<void>` | ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿å–å¾— | `AuthService.getUserData()` |
| `deleteAccount()` | ãªã— | `Future<void>` | ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤ | `AuthService.deleteAccount()` |

**ä½¿ç”¨ä¾‹**:

```dart
// UIã‹ã‚‰ã®å‘¼ã³å‡ºã—
final controller = ref.read(authControllerProvider.notifier);

// æ–°è¦ç™»éŒ²
await controller.signUpWithEmail(
  email: 'user@example.com',
  password: 'password123',
  nickname: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼å¤ªéƒ',
);

// ãƒ­ã‚°ã‚¤ãƒ³
await controller.signInWithEmail(
  email: 'user@example.com',
  password: 'password123',
);

// ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
await controller.signOut();
```

---

### 2. AuthServiceï¼ˆFirebaseå®Ÿè£…ï¼‰

**ãƒ•ã‚¡ã‚¤ãƒ«**: `services/auth_service.dart`

**å½¹å‰²**: Firebase Authenticationã¨Firestoreã®æ“ä½œã‚’å®Ÿè£…

**ä¾å­˜ãƒ©ã‚¤ãƒ–ãƒ©ãƒª**:
- `firebase_auth`: Firebase Authentication
- `cloud_firestore`: Cloud Firestore

**ä¸»è¦ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰**:

```dart
class AuthService implements AuthRepository {
  final FirebaseAuth _auth = FirebaseAuth.instance;
  final FirebaseFirestore _firestore = FirebaseFirestore.instance;

  // ...
}
```

**ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**:

```dart
// Firebaseã®ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ â†’ æ—¥æœ¬èªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å¤‰æ›
Future<void> _handleAuthException(FirebaseAuthException e) async {
  switch (e.code) {
    case 'weak-password':
      throw 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒå¼±ã™ãã¾ã™ï¼ˆ6æ–‡å­—ä»¥ä¸Šï¼‰';
    case 'email-already-in-use':
      throw 'ã“ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯æ—¢ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™';
    case 'user-not-found':
      throw 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“';
    case 'wrong-password':
      throw 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé–“é•ã£ã¦ã„ã¾ã™';
    case 'invalid-email':
      throw 'ç„¡åŠ¹ãªãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã§ã™';
    // ...
  }
}
```

**Firestoreãƒ‘ã‚¹**:

```
users/{userId}
  â†“ ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³
  - id: string
  - nickname: string
  - email: string
  - ageRange: string
  - region: string
  - iconUrl: string
  - createdAt: Timestamp
  - updatedAt: Timestamp
```

---

### 3. StorageServiceï¼ˆç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼‰

**ãƒ•ã‚¡ã‚¤ãƒ«**: `services/storage_service.dart`

**å½¹å‰²**: Firebase Storageã¸ã®ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ»å‰Šé™¤

**ä¸»è¦ãƒ¡ã‚½ãƒƒãƒ‰**:

| ãƒ¡ã‚½ãƒƒãƒ‰ | å¼•æ•° | æˆ»ã‚Šå€¤ | èª¬æ˜ |
|---------|------|--------|------|
| `uploadProfileImage()` | userId, imageFile | `Future<String>` | ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦URLã‚’è¿”ã™ |
| `deleteProfileImage()` | imageUrl | `Future<void>` | ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒã‚’å‰Šé™¤ |

**ç”»åƒå‡¦ç†**:

```dart
Future<String> uploadProfileImage({
  required String userId,
  required File imageFile,
}) async {
  // 1. ç”»åƒã‚’ãƒªã‚µã‚¤ã‚ºï¼ˆ1024x1024ã€ç”»è³ª85%ï¼‰
  final compressedImage = await FlutterImageCompress.compressWithFile(
    imageFile.path,
    quality: 85,
    minWidth: 1024,
    minHeight: 1024,
  );

  // 2. Firebase Storageã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
  final storageRef = _storage.ref().child('profile_images/$userId.jpg');
  await storageRef.putData(compressedImage);

  // 3. ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰URLã‚’å–å¾—ã—ã¦è¿”ã™
  return await storageRef.getDownloadURL();
}
```

**Storageãƒ‘ã‚¹**:

```
profile_images/{userId}.jpg
```

---

### 4. ProfileSetupNotifierï¼ˆãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¨­å®šï¼‰

**ãƒ•ã‚¡ã‚¤ãƒ«**: `providers/profile_setup_provider.dart`

**å½¹å‰²**: ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¨­å®šç”»é¢ã®çŠ¶æ…‹ç®¡ç†ã¨ãƒ­ã‚¸ãƒƒã‚¯

**ä¾å­˜Provider**:
- `authControllerProvider`: ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æ›´æ–°
- `storageServiceProvider`: ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰

**å‡¦ç†ãƒ•ãƒ­ãƒ¼ï¼ˆsaveProfileï¼‰**:

```dart
Future<bool> saveProfile({
  required String userId,
  required String nickname,
}) async {
  // 1. ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
  if (state.selectedAgeRange == null || state.selectedRegion == null) {
    state = state.copyWith(errorMessage: 'å¹´é½¢ã¨åœ°åŸŸã‚’é¸æŠã—ã¦ãã ã•ã„');
    return false;
  }

  // 2. ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰é–‹å§‹
  state = state.copyWith(isUploading: true);

  try {
    String iconUrl = '';

    // 3. ç”»åƒãŒã‚ã‚‹å ´åˆã¯ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
    if (state.selectedImage != null) {
      final storageService = ref.read(storageServiceProvider);
      iconUrl = await storageService.uploadProfileImage(
        userId: userId,
        imageFile: state.selectedImage!,
      );
    }

    // 4. ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æ›´æ–°
    await ref.read(authControllerProvider.notifier).updateProfile(
      userId: userId,
      nickname: nickname,
      ageRange: state.selectedAgeRange!,
      region: state.selectedRegion!,
      iconUrl: iconUrl.isNotEmpty ? iconUrl : null,
    );

    // 5. æˆåŠŸ
    state = state.copyWith(isUploading: false);
    return true;

  } catch (e) {
    // 6. ã‚¨ãƒ©ãƒ¼å‡¦ç†
    state = state.copyWith(
      isUploading: false,
      errorMessage: e.toString(),
    );
    return false;
  }
}
```

---

## ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼ã¨å‡¦ç†ã®æµã‚Œ

### æ–°è¦ç™»éŒ²ãƒ•ãƒ­ãƒ¼ã®è©³ç´°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [1] ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒSignUpPageã§ãƒ•ã‚©ãƒ¼ãƒ å…¥åŠ›                           â”‚
â”‚     - nickname: "å¤ªéƒ"                                          â”‚
â”‚     - email: "taro@example.com"                                 â”‚
â”‚     - password: "password123"                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [2] ç™»éŒ²ãƒœã‚¿ãƒ³æŠ¼ä¸‹                                                 â”‚
â”‚     signup_page.dart:_handleSignUp()                              â”‚
â”‚     â†“                                                             â”‚
â”‚     ref.read(authControllerProvider.notifier).signUpWithEmail()   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [3] AuthController.signUpWithEmail()                              â”‚
â”‚     providers/auth_provider.dart                                  â”‚
â”‚     â†“                                                             â”‚
â”‚     state = AuthState.loading()  // çŠ¶æ…‹ã‚’ã€Œå‡¦ç†ä¸­ã€ã«            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [4] AuthService.signUpWithEmail()                                 â”‚
â”‚     services/auth_service.dart                                    â”‚
â”‚     â†“                                                             â”‚
â”‚     final credential = await _auth.createUserWithEmailAndPassword(â”‚
â”‚       email: email,                                               â”‚
â”‚       password: password,                                         â”‚
â”‚     );                                                            â”‚
â”‚     // â†’ Firebase Authenticationã§ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆ                   â”‚
â”‚     // â†’ Firebase UIDã‚’å–å¾—                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [5] UserModelã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆ                                      â”‚
â”‚     auth_service.dart                                             â”‚
â”‚     â†“                                                             â”‚
â”‚     final user = UserModel(                                       â”‚
â”‚       id: credential.user!.uid,                                   â”‚
â”‚       nickname: nickname,                                         â”‚
â”‚       email: email,                                               â”‚
â”‚       ageRange: '',                                               â”‚
â”‚       region: '',                                                 â”‚
â”‚       iconUrl: 'assets/images/default_avatar.png',               â”‚
â”‚       createdAt: DateTime.now(),                                  â”‚
â”‚       updatedAt: DateTime.now(),                                  â”‚
â”‚     );                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [6] Firestoreã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ä¿å­˜                                  â”‚
â”‚     AuthService.saveUserData()                                    â”‚
â”‚     â†“                                                             â”‚
â”‚     await _firestore.collection('users').doc(user.id).set(        â”‚
â”‚       user.toJson(),                                              â”‚
â”‚     );                                                            â”‚
â”‚     // â†’ users/{uid}ã«ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä½œæˆ                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [7] çŠ¶æ…‹ã‚’ã€Œèªè¨¼æ¸ˆã¿ã€ã«æ›´æ–°                                        â”‚
â”‚     AuthController                                                â”‚
â”‚     â†“                                                             â”‚
â”‚     state = AuthState.authenticated(user);                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [8] UIã§çŠ¶æ…‹å¤‰åŒ–ã‚’æ¤œçŸ¥                                             â”‚
â”‚     signup_page.dart                                              â”‚
â”‚     â†“                                                             â”‚
â”‚     ref.listen<AuthState>(authControllerProvider, (prev, next) {  â”‚
â”‚       next.when(                                                  â”‚
â”‚         authenticated: (user) {                                   â”‚
â”‚           context.go('/profile-setup');  // ç”»é¢é·ç§»               â”‚
â”‚         },                                                        â”‚
â”‚         error: (msg) => showSnackBar(msg),                        â”‚
â”‚         // ...                                                    â”‚
â”‚       );                                                          â”‚
â”‚     });                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [9] ProfileSetupPageã«é·ç§»                                        â”‚
â”‚     ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¨­å®šç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã‚‹                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¨­å®šãƒ•ãƒ­ãƒ¼ã®è©³ç´°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [1] ProfileSetupPageã§ç”»åƒé¸æŠãƒœã‚¿ãƒ³æŠ¼ä¸‹                          â”‚
â”‚     profile_setup_page.dart                                      â”‚
â”‚     â†“                                                            â”‚
â”‚     ref.read(profileSetupProvider.notifier).pickImage()          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [2] ImagePickerã§ç”»åƒé¸æŠ                                         â”‚
â”‚     ProfileSetupNotifier.pickImage()                              â”‚
â”‚     â†“                                                             â”‚
â”‚     final image = await _imagePicker.pickImage(                   â”‚
â”‚       source: ImageSource.gallery,                                â”‚
â”‚     );                                                            â”‚
â”‚     if (image != null) {                                          â”‚
â”‚       state = state.copyWith(selectedImage: File(image.path));    â”‚
â”‚     }                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [3] UIã§ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°                                         â”‚
â”‚     profile_setup_page.dart                                       â”‚
â”‚     â†“                                                             â”‚
â”‚     final profileState = ref.watch(profileSetupProvider);         â”‚
â”‚     if (profileState.selectedImage != null) {                     â”‚
â”‚       Image.file(profileState.selectedImage!)  // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º   â”‚
â”‚     }                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå¹´é½¢ãƒ»åœ°åŸŸã‚’é¸æŠ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [4] å¹´é½¢ç¯„å›²é¸æŠ                                                   â”‚
â”‚     ref.read(profileSetupProvider.notifier).setAgeRange('20ä»£')   â”‚
â”‚     â†“                                                             â”‚
â”‚     state = state.copyWith(selectedAgeRange: '20ä»£');             â”‚
â”‚                                                                   â”‚
â”‚ [5] åœ°åŸŸé¸æŠ                                                       â”‚
â”‚     ref.read(profileSetupProvider.notifier).setRegion('æ±äº¬éƒ½')   â”‚
â”‚     â†“                                                             â”‚
â”‚     state = state.copyWith(selectedRegion: 'æ±äº¬éƒ½');             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼ ä¿å­˜ãƒœã‚¿ãƒ³æŠ¼ä¸‹
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [6] ProfileSetupNotifier.saveProfile()                            â”‚
â”‚     â†“                                                             â”‚
â”‚     state = state.copyWith(isUploading: true);                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [7] ç”»åƒã‚’Firebase Storageã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆç”»åƒãŒã‚ã‚‹å ´åˆï¼‰          â”‚
â”‚     StorageService.uploadProfileImage()                           â”‚
â”‚     â†“                                                             â”‚
â”‚     final iconUrl = await storageService.uploadProfileImage(      â”‚
â”‚       userId: userId,                                             â”‚
â”‚       imageFile: state.selectedImage!,                            â”‚
â”‚     );                                                            â”‚
â”‚     // â†’ profile_images/{userId}.jpgã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰                 â”‚
â”‚     // â†’ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰URLã‚’å–å¾—                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [8] ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ã‚’æ›´æ–°                                         â”‚
â”‚     AuthController.updateProfile()                                â”‚
â”‚     â†“                                                             â”‚
â”‚     await _authRepository.updateUserData(updatedUser);            â”‚
â”‚     // â†’ Firestore: users/{userId}ã‚’æ›´æ–°                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [9] çŠ¶æ…‹æ›´æ–°                                                       â”‚
â”‚     state = AuthState.authenticated(updatedUser);                 â”‚
â”‚     profileState = profileState.copyWith(isUploading: false);     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [10] ãƒ›ãƒ¼ãƒ ç”»é¢ã«é·ç§»                                              â”‚
â”‚      context.go('/');                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ä»–ã®featureã¨ã®é€£æº

### 1. settings feature ã¨ã®é€£æº

**ãƒ•ã‚¡ã‚¤ãƒ«**: `lib/feature/settings/`

**é€£æºæ–¹æ³•**:

```dart
// settings/presentation/pages/profile_screen.dart

import '../../auth/providers/auth_provider.dart';
import '../../auth/models/user/user_model.dart';

class ProfileScreen extends ConsumerWidget {
  @override
  Widget build(BuildContext context, WidgetRef ref) {
    // ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—
    final currentUserAsync = ref.watch(currentUserProvider);

    return currentUserAsync.when(
      data: (user) {
        if (user == null) return Text('æœªãƒ­ã‚°ã‚¤ãƒ³');

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’è¡¨ç¤º
        return Column(
          children: [
            CircleAvatar(
              backgroundImage: NetworkImage(user.iconUrl),
            ),
            Text(user.nickname),
            Text(user.email),
            // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†ãƒœã‚¿ãƒ³
            ElevatedButton(
              onPressed: () {
                // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†æ©Ÿèƒ½ã‚’å‘¼ã³å‡ºã—
                ref.read(authControllerProvider.notifier).updateProfile(
                  userId: user.id,
                  nickname: 'æ–°ã—ã„ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ',
                  // ...
                );
              },
              child: Text('ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†'),
            ),
          ],
        );
      },
      loading: () => CircularProgressIndicator(),
      error: (e, _) => Text('ã‚¨ãƒ©ãƒ¼: $e'),
    );
  }
}
```

### 2. home feature ã¨ã®é€£æº

**ãƒ•ã‚¡ã‚¤ãƒ«**: `lib/feature/home/`

**é€£æºæ–¹æ³•**:

```dart
// home/presentation/pages/home.dart

import '../../auth/providers/auth_provider.dart';

class HomePage extends ConsumerWidget {
  @override
  Widget build(BuildContext context, WidgetRef ref) {
    // èªè¨¼çŠ¶æ…‹ã‚’ç›£è¦–
    final authState = ref.watch(authControllerProvider);

    return authState.when(
      authenticated: (user) {
        // èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘ã®ç”»é¢
        return Scaffold(
          appBar: AppBar(
            title: Text('ã“ã‚“ã«ã¡ã¯ã€${user.nickname}ã•ã‚“'),
          ),
          body: HomeContent(),
        );
      },
      guest: () {
        // ã‚²ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘ã®ç”»é¢
        return Scaffold(
          appBar: AppBar(
            title: Text('ã‚²ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰'),
          ),
          body: GuestContent(),
        );
      },
      unauthenticated: () {
        // æœªèªè¨¼ã®å ´åˆã€ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
        WidgetsBinding.instance.addPostFrameCallback((_) {
          context.go('/login');
        });
        return SizedBox();
      },
      loading: () => Scaffold(
        body: Center(child: CircularProgressIndicator()),
      ),
      error: (message) => Scaffold(
        body: Center(child: Text('ã‚¨ãƒ©ãƒ¼: $message')),
      ),
      initial: () => Scaffold(
        body: Center(child: CircularProgressIndicator()),
      ),
    );
  }
}
```

### 3. core/route (GoRouter) ã¨ã®é€£æº

**ãƒ•ã‚¡ã‚¤ãƒ«**: `lib/core/route/app_router.dart`

**èªè¨¼çŠ¶æ…‹ã«ã‚ˆã‚‹ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ**:

```dart
import '../../feature/auth/providers/auth_provider.dart';

final routerProvider = Provider<GoRouter>((ref) {
  return GoRouter(
    redirect: (context, state) {
      // èªè¨¼çŠ¶æ…‹ã®Streamã‚’ç›£è¦–
      final authStateAsync = ref.watch(authStateChangesProvider);

      return authStateAsync.when(
        data: (user) {
          final isAuthRoute = state.matchedLocation.startsWith('/login') ||
                             state.matchedLocation.startsWith('/signup');

          if (user == null) {
            // æœªèªè¨¼ãƒ¦ãƒ¼ã‚¶ãƒ¼ â†’ ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢
            return isAuthRoute ? null : '/login';
          } else {
            // èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ â†’ ãƒ›ãƒ¼ãƒ ç”»é¢
            return isAuthRoute ? '/' : null;
          }
        },
        loading: () => null,
        error: (_, __) => '/login',
      );
    },
    routes: [
      GoRoute(
        path: '/login',
        builder: (context, state) => const LoginPage(),
      ),
      GoRoute(
        path: '/signup',
        builder: (context, state) => const SignUpPage(),
      ),
      GoRoute(
        path: '/profile-setup',
        builder: (context, state) => const ProfileSetupPage(),
      ),
      GoRoute(
        path: '/',
        builder: (context, state) => const HomePage(),
      ),
      // ...
    ],
  );
});
```

### 4. ä»–ã®featureã§ã®ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼IDå–å¾—

```dart
// ã©ã®featureã‹ã‚‰ã§ã‚‚ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’å–å¾—å¯èƒ½

import '../../auth/providers/auth_provider.dart';

class SomeFeature extends ConsumerWidget {
  Future<void> doSomething(WidgetRef ref) async {
    // æ–¹æ³•1: authControllerProviderã‹ã‚‰å–å¾—
    final authState = ref.read(authControllerProvider);
    authState.whenOrNull(
      authenticated: (user) {
        final userId = user.id;
        // userIdã‚’ä½¿ã£ã¦å‡¦ç†
      },
    );

    // æ–¹æ³•2: currentUserProviderã‹ã‚‰å–å¾—
    final currentUser = await ref.read(currentUserProvider.future);
    if (currentUser != null) {
      final userId = currentUser.id;
      // userIdã‚’ä½¿ã£ã¦å‡¦ç†
    }
  }
}
```

---

## ä½¿ç”¨æ–¹æ³•

### 1. æ–°è¦ç™»éŒ²ã®å®Ÿè£…ä¾‹

```dart
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import '../providers/auth_provider.dart';
import '../providers/auth_state.dart';

class SignUpPage extends ConsumerStatefulWidget {
  const SignUpPage({super.key});

  @override
  ConsumerState<SignUpPage> createState() => _SignUpPageState();
}

class _SignUpPageState extends ConsumerState<SignUpPage> {
  final _formKey = GlobalKey<FormState>();
  final _nicknameController = TextEditingController();
  final _emailController = TextEditingController();
  final _passwordController = TextEditingController();

  @override
  Widget build(BuildContext context) {
    // èªè¨¼çŠ¶æ…‹ã‚’ç›£è¦–ã—ã¦ã€ç”»é¢é·ç§»ã‚„ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
    ref.listen<AuthState>(authControllerProvider, (previous, next) {
      next.when(
        authenticated: (user) {
          // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¨­å®šç”»é¢ã¸é·ç§»
          context.go('/profile-setup');
        },
        error: (message) {
          // ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
          ScaffoldMessenger.of(context).showSnackBar(
            SnackBar(content: Text(message)),
          );
        },
        initial: () {},
        loading: () {},
        guest: () {},
        unauthenticated: () {},
      );
    });

    final authState = ref.watch(authControllerProvider);
    final isLoading = authState is _Loading;

    return Scaffold(
      appBar: AppBar(title: Text('æ–°è¦ç™»éŒ²')),
      body: Form(
        key: _formKey,
        child: ListView(
          padding: EdgeInsets.all(16),
          children: [
            TextFormField(
              controller: _nicknameController,
              decoration: InputDecoration(labelText: 'ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ '),
              validator: (value) {
                if (value == null || value.isEmpty) {
                  return 'ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
                }
                if (value.length < 2 || value.length > 20) {
                  return 'ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã¯2ã€œ20æ–‡å­—ã§å…¥åŠ›ã—ã¦ãã ã•ã„';
                }
                return null;
              },
            ),
            TextFormField(
              controller: _emailController,
              decoration: InputDecoration(labelText: 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹'),
              keyboardType: TextInputType.emailAddress,
              validator: (value) {
                if (value == null || value.isEmpty) {
                  return 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
                }
                final emailRegex = RegExp(r'^[\w-\.]+@([\w-]+\.)+[\w-]{2,4}$');
                if (!emailRegex.hasMatch(value)) {
                  return 'æœ‰åŠ¹ãªãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
                }
                return null;
              },
            ),
            TextFormField(
              controller: _passwordController,
              decoration: InputDecoration(labelText: 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰'),
              obscureText: true,
              validator: (value) {
                if (value == null || value.isEmpty) {
                  return 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
                }
                if (value.length < 6) {
                  return 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯6æ–‡å­—ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„';
                }
                return null;
              },
            ),
            SizedBox(height: 24),
            ElevatedButton(
              onPressed: isLoading ? null : () async {
                if (_formKey.currentState!.validate()) {
                  await ref.read(authControllerProvider.notifier).signUpWithEmail(
                    email: _emailController.text,
                    password: _passwordController.text,
                    nickname: _nicknameController.text,
                  );
                }
              },
              child: isLoading
                  ? CircularProgressIndicator()
                  : Text('ç™»éŒ²'),
            ),
          ],
        ),
      ),
    );
  }
}
```

### 2. ãƒ­ã‚°ã‚¤ãƒ³ã®å®Ÿè£…ä¾‹

```dart
class LoginPage extends ConsumerStatefulWidget {
  const LoginPage({super.key});

  @override
  ConsumerState<LoginPage> createState() => _LoginPageState();
}

class _LoginPageState extends ConsumerState<LoginPage> {
  final _emailController = TextEditingController();
  final _passwordController = TextEditingController();

  @override
  Widget build(BuildContext context) {
    // èªè¨¼çŠ¶æ…‹ã‚’ç›£è¦–
    ref.listen<AuthState>(authControllerProvider, (previous, next) {
      next.when(
        authenticated: (user) => context.go('/'),  // ãƒ›ãƒ¼ãƒ ã¸
        error: (message) => ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(content: Text(message)),
        ),
        initial: () {},
        loading: () {},
        guest: () {},
        unauthenticated: () {},
      );
    });

    final authState = ref.watch(authControllerProvider);
    final isLoading = authState is _Loading;

    return Scaffold(
      appBar: AppBar(title: Text('ãƒ­ã‚°ã‚¤ãƒ³')),
      body: Padding(
        padding: EdgeInsets.all(16),
        child: Column(
          children: [
            TextField(
              controller: _emailController,
              decoration: InputDecoration(labelText: 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹'),
            ),
            TextField(
              controller: _passwordController,
              decoration: InputDecoration(labelText: 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰'),
              obscureText: true,
            ),
            SizedBox(height: 24),
            ElevatedButton(
              onPressed: isLoading ? null : () async {
                await ref.read(authControllerProvider.notifier).signInWithEmail(
                  email: _emailController.text,
                  password: _passwordController.text,
                );
              },
              child: isLoading ? CircularProgressIndicator() : Text('ãƒ­ã‚°ã‚¤ãƒ³'),
            ),
            TextButton(
              onPressed: () => context.go('/signup'),
              child: Text('ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆ'),
            ),
            TextButton(
              onPressed: () {
                ref.read(authControllerProvider.notifier).continueAsGuest();
              },
              child: Text('ã‚²ã‚¹ãƒˆã¨ã—ã¦ç¶šã‘ã‚‹'),
            ),
          ],
        ),
      ),
    );
  }
}
```

### 3. ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®è¡¨ç¤º

```dart
class UserProfileWidget extends ConsumerWidget {
  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final currentUserAsync = ref.watch(currentUserProvider);

    return currentUserAsync.when(
      data: (user) {
        if (user == null) {
          return Text('ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã¾ã›ã‚“');
        }
        return Column(
          children: [
            CircleAvatar(
              radius: 40,
              backgroundImage: user.iconUrl.startsWith('http')
                  ? NetworkImage(user.iconUrl)
                  : AssetImage(user.iconUrl) as ImageProvider,
            ),
            SizedBox(height: 8),
            Text(
              user.nickname,
              style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold),
            ),
            Text(user.email),
            Text('${user.ageRange} | ${user.region}'),
          ],
        );
      },
      loading: () => CircularProgressIndicator(),
      error: (error, stack) => Text('ã‚¨ãƒ©ãƒ¼: $error'),
    );
  }
}
```

### 4. ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ

```dart
ElevatedButton(
  onPressed: () async {
    await ref.read(authControllerProvider.notifier).signOut();
    context.go('/login');
  },
  child: Text('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ'),
)
```

---

## æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯

### ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸

| ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ | ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | ç”¨é€” |
|-----------|----------|------|
| `firebase_auth` | ^4.x.x | Firebase Authentication |
| `cloud_firestore` | ^4.x.x | Cloud Firestore |
| `firebase_storage` | ^11.x.x | Firebase Storage |
| `flutter_hooks` | ^0.20.x | React Hooksé¢¨ã®çŠ¶æ…‹ç®¡ç† |
| `hooks_riverpod` | ^2.x.x | Flutter Hooks + Riverpodçµ±åˆ |
| `flutter_riverpod` | ^2.x.x | çŠ¶æ…‹ç®¡ç†ï¼ˆæ—§UIç”¨ï¼‰ |
| `freezed` | ^2.x.x | ä¸å¤‰ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒ©ã‚¹ |
| `freezed_annotation` | ^2.x.x | Freezedã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ |
| `json_annotation` | ^4.x.x | JSONã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³ |
| `go_router` | ^13.x.x | ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚° |
| `image_picker` | ^1.x.x | ç”»åƒé¸æŠ |
| `flutter_image_compress` | ^2.x.x | ç”»åƒåœ§ç¸® |

### é–‹ç™ºæ™‚ã®ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸

| ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ | ç”¨é€” |
|-----------|------|
| `build_runner` | ã‚³ãƒ¼ãƒ‰ç”Ÿæˆ |
| `freezed` | Freezedã‚³ãƒ¼ãƒ‰ç”Ÿæˆ |
| `json_serializable` | JSONç”Ÿæˆ |

### ã‚³ãƒ¼ãƒ‰ç”Ÿæˆã‚³ãƒãƒ³ãƒ‰

```bash
# Freezed + JSONç”Ÿæˆ
flutter pub run build_runner build --delete-conflicting-outputs

# ã‚¦ã‚©ãƒƒãƒãƒ¢ãƒ¼ãƒ‰ï¼ˆè‡ªå‹•ç”Ÿæˆï¼‰
flutter pub run build_runner watch --delete-conflicting-outputs
```

---

## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

### Firestore Security Rules

**ãƒ•ã‚¡ã‚¤ãƒ«**: `firestore.rules.example`

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³
    match /users/{userId} {
      // èª­ã¿å–ã‚Š: èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿
      allow read: if request.auth != null;

      // æ›¸ãè¾¼ã¿: æœ¬äººã®ã¿
      allow write: if request.auth != null && request.auth.uid == userId;
    }
  }
}
```

### Firebase Storage Security Rules

**ãƒ•ã‚¡ã‚¤ãƒ«**: `storage.rules.example`

```javascript
rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒ
    match /profile_images/{userId}.{ext} {
      // èª­ã¿å–ã‚Š: èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿
      allow read: if request.auth != null;

      // æ›¸ãè¾¼ã¿: æœ¬äººã®ã¿ã€æœ€å¤§5MB
      allow write: if request.auth != null
                   && request.auth.uid == userId
                   && request.resource.size < 5 * 1024 * 1024;
    }
  }
}
```

### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

- âœ… ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯6æ–‡å­—ä»¥ä¸Šï¼ˆFirebase Authenticationã®åˆ¶ç´„ï¼‰
- âœ… ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å½¢å¼ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
- âœ… Firestore Security Rulesã«ã‚ˆã‚‹ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡
- âœ… Storage Security Rulesã«ã‚ˆã‚‹ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡
- âœ… Firebase Authenticationã«ã‚ˆã‚‹èªè¨¼
- âœ… ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æ—¥æœ¬èªåŒ–ï¼ˆæŠ€è¡“çš„è©³ç´°ã‚’éš è”½ï¼‰
- âœ… ç”»åƒã‚µã‚¤ã‚ºåˆ¶é™ï¼ˆæœ€å¤§5MBï¼‰
- âœ… ç”»åƒã®ãƒªã‚µã‚¤ã‚ºå‡¦ç†

---

## ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### 1. ãƒ­ã‚°ã‚¤ãƒ³å¾Œã«ç”»é¢ãŒé·ç§»ã—ãªã„

**åŸå› **: `authStateChangesProvider`ãŒæ­£ã—ãç›£è¦–ã•ã‚Œã¦ã„ãªã„

**è§£æ±ºç­–**:
```dart
// app_router.dartã§ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆè¨­å®šã‚’ç¢ºèª
redirect: (context, state) {
  final authStateAsync = ref.watch(authStateChangesProvider);
  // ...
}
```

### 2. ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒãŒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã§ããªã„

**åŸå› **: Firebase Storage Security RulesãŒè¨­å®šã•ã‚Œã¦ã„ãªã„

**è§£æ±ºç­–**: Firebaseã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§`storage.rules.example`ã®å†…å®¹ã‚’é©ç”¨

### 3. Freezedãƒ•ã‚¡ã‚¤ãƒ«ãŒç”Ÿæˆã•ã‚Œãªã„

**åŸå› **: `build_runner`ãŒå®Ÿè¡Œã•ã‚Œã¦ã„ãªã„

**è§£æ±ºç­–**:
```bash
flutter pub run build_runner build --delete-conflicting-outputs
```

### 4. iOS ã§ç”»åƒé¸æŠæ™‚ã«ã‚¯ãƒ©ãƒƒã‚·ãƒ¥

**åŸå› **: `Info.plist`ã«æ¨©é™ã®è¨˜è¿°ãŒãªã„

**è§£æ±ºç­–**: `ios/Runner/Info.plist`ã«è¿½åŠ 
```xml
<key>NSPhotoLibraryUsageDescription</key>
<string>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒã‚’è¨­å®šã™ã‚‹ãŸã‚ã«å†™çœŸãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒå¿…è¦ã§ã™</string>
```

### 5. Android ã§ç”»åƒé¸æŠæ™‚ã«ã‚¯ãƒ©ãƒƒã‚·ãƒ¥

**åŸå› **: `AndroidManifest.xml`ã«æ¨©é™ã®è¨˜è¿°ãŒãªã„

**è§£æ±ºç­–**: `android/app/src/main/AndroidManifest.xml`ã«è¿½åŠ 
```xml
<uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE"/>
<uses-permission android:name="android.permission.READ_MEDIA_IMAGES"/> <!-- Android 13+ -->
```

### 6. èªè¨¼çŠ¶æ…‹ãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œã‚‹

**åŸå› **: Firebase Authenticationã®æ°¸ç¶šåŒ–ãŒç„¡åŠ¹ã«ãªã£ã¦ã„ã‚‹

**è§£æ±ºç­–**: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§æ°¸ç¶šåŒ–ã¯æœ‰åŠ¹ãªã®ã§ã€é€šå¸¸ã¯å•é¡Œãªã—ã€‚æ˜ç¤ºçš„ã«è¨­å®šã™ã‚‹å ´åˆ:
```dart
await FirebaseAuth.instance.setPersistence(Persistence.LOCAL);
```

---

## ã¾ã¨ã‚

ã“ã®èªè¨¼æ©Ÿèƒ½ã¯ã€ä»¥ä¸‹ã®ç‰¹å¾´ã‚’æŒã¤å …ç‰¢ãªã‚·ã‚¹ãƒ†ãƒ ã§ã™ï¼š

âœ… **ãƒ¬ã‚¤ãƒ¤ãƒ¼åˆ†é›¢**: Presentation â†’ Provider â†’ Repository â†’ Service
âœ… **çŠ¶æ…‹ç®¡ç†**: Riverpodã«ã‚ˆã‚‹å®£è¨€çš„UI
âœ… **ä¸å¤‰æ€§**: Freezedã«ã‚ˆã‚‹å‹å®‰å…¨æ€§
âœ… **ãƒ†ã‚¹ãƒˆå¯èƒ½**: Repository Patternã«ã‚ˆã‚‹ãƒ¢ãƒƒã‚¯åŒ–
âœ… **ã‚»ã‚­ãƒ¥ã‚¢**: Firebase + Security Rulesã«ã‚ˆã‚‹å¤šå±¤é˜²å¾¡
âœ… **æ‹¡å¼µæ€§**: æ–°æ©Ÿèƒ½ã®è¿½åŠ ãŒå®¹æ˜“
âœ… **ä¿å®ˆæ€§**: å„å±¤ã®è²¬å‹™ãŒæ˜ç¢º

### é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- `ARCHITECTURE.md`: ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è©³ç´°è¨­è¨ˆ
- `firestore.rules.example`: Firestoreã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«
- `storage.rules.example`: Storageã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«

### å‚è€ƒãƒªãƒ³ã‚¯

- [Firebase Authentication - Flutter](https://firebase.google.com/docs/auth/flutter/start)
- [Cloud Firestore - Flutter](https://firebase.google.com/docs/firestore/quickstart?hl=ja#flutter)
- [Firebase Storage - Flutter](https://firebase.google.com/docs/storage/flutter/start)
- [Riverpod](https://riverpod.dev/)
- [Freezed](https://pub.dev/packages/freezed)
- [GoRouter](https://pub.dev/packages/go_router)

---

## å¤‰æ›´å±¥æ­´

### 2025å¹´12æœˆ26æ—¥ - Flutter Hooks ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°

å…¨ã¦ã®èªè¨¼ç”»é¢ã‚’ `ConsumerStatefulWidget` ã‹ã‚‰ `HookConsumerWidget` ã«ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã—ã¾ã—ãŸã€‚

#### å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«

1. **lib/feature/auth/presentaion/pages/login.dart**
2. **lib/feature/auth/presentaion/pages/signup_page.dart**
3. **lib/feature/auth/presentaion/pages/profile_setup_page.dart**
4. **lib/feature/auth/presentaion/pages/change_password_page.dart**
5. **lib/feature/auth/presentaion/pages/forgot_password_page.dart**

#### ä¸»ãªå¤‰æ›´å†…å®¹

**1. Widget ã‚¯ãƒ©ã‚¹ã®å¤‰æ›´**
```dart
// Before
class LoginPage extends ConsumerStatefulWidget {
  @override
  ConsumerState<LoginPage> createState() => _LoginPageState();
}

class _LoginPageState extends ConsumerState<LoginPage> {
  // ...
}

// After
class LoginPage extends HookConsumerWidget {
  @override
  Widget build(BuildContext context, WidgetRef ref) {
    // ...
  }
}
```

**2. TextEditingController ã®ç®¡ç†**
```dart
// Before
final _emailController = TextEditingController();

@override
void dispose() {
  _emailController.dispose();
  super.dispose();
}

// After
final emailController = useTextEditingController();
// è‡ªå‹•çš„ã«ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã•ã‚Œã‚‹
```

**3. çŠ¶æ…‹ç®¡ç†ã®å¤‰æ›´**
```dart
// Before
bool _obscurePassword = true;

setState(() {
  _obscurePassword = !_obscurePassword;
});

// After
final obscurePassword = useState(true);

obscurePassword.value = !obscurePassword.value;
```

**4. GlobalKey ã®ç®¡ç†**
```dart
// Before
final _formKey = GlobalKey<FormState>();

// After
final formKey = useMemoized(() => GlobalKey<FormState>());
```

**5. å‘½åè¦å‰‡ã®å¤‰æ›´**
- ã™ã¹ã¦ã®ã‚¢ãƒ³ãƒ€ãƒ¼ã‚¹ã‚³ã‚¢ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ï¼ˆ`_`ï¼‰ã‚’å‰Šé™¤
- ä¾‹: `_emailController` â†’ `emailController`
- ä¾‹: `_handleLogin()` â†’ `handleLogin()`

#### ãƒ¡ãƒªãƒƒãƒˆ

âœ… **è‡ªå‹•ãƒªã‚½ãƒ¼ã‚¹ç®¡ç†**: `dispose()` ãƒ¡ã‚½ãƒƒãƒ‰ãŒä¸è¦ã«ãªã‚Šã€ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯ã®ãƒªã‚¹ã‚¯ãŒä½æ¸›
âœ… **ã‚³ãƒ¼ãƒ‰ã®ç°¡æ½”åŒ–**: StatefulWidget ã®ãƒœã‚¤ãƒ©ãƒ¼ãƒ—ãƒ¬ãƒ¼ãƒˆã‚³ãƒ¼ãƒ‰ãŒå‰Šæ¸›
âœ… **å¯èª­æ€§ã®å‘ä¸Š**: ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã¨ UI ãƒ­ã‚¸ãƒƒã‚¯ã®åˆ†é›¢ãŒæ˜ç¢ºã«
âœ… **ä¿å®ˆæ€§ã®å‘ä¸Š**: çŠ¶æ…‹ç®¡ç†ãŒã‚ˆã‚Šå®£è¨€çš„ã§è¿½è·¡ã—ã‚„ã™ã„
âœ… **React é–‹ç™ºè€…ã«ã‚‚è¦ªã—ã¿ã‚„ã™ã„**: React Hooks ã¨åŒæ§˜ã® API

#### ä¾å­˜é–¢ä¿‚ã®è¿½åŠ 

```yaml
dependencies:
  flutter_hooks: 0.21.3
  hooks_riverpod: 3.0.3
```

#### æ¤œè¨¼çµæœ

- `flutter analyze` ã«ã‚ˆã‚‹é™çš„è§£æ: âœ… ã‚¨ãƒ©ãƒ¼ãªã—
- ã™ã¹ã¦ã®èªè¨¼ãƒšãƒ¼ã‚¸ãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹ã“ã¨ã‚’ç¢ºèª

---

**æœ€çµ‚æ›´æ–°**: 2025å¹´12æœˆ26æ—¥
**ãƒ¡ãƒ³ãƒ†ãƒŠãƒ¼**: é–‹ç™ºãƒãƒ¼ãƒ 
